name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate

      - name: Build CSS
        run: npx tailwindcss -i ./src/public/css/input.css -o ./src/public/css/output.css --minify

      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ ERRO: Secret VPS_HOST nÃ£o estÃ¡ configurado!"
            echo "Acesse: https://github.com/othonet/app_offline/settings/secrets/actions"
            echo "Adicione o secret VPS_HOST com o valor: srv1150760.hstgr.cloud"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ ERRO: Secret VPS_USER nÃ£o estÃ¡ configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ ERRO: Secret VPS_SSH_KEY nÃ£o estÃ¡ configurado!"
            exit 1
          fi
          echo "âœ… Todos os secrets obrigatÃ³rios estÃ£o configurados"

      - name: Verify SSH connection and prepare directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "âœ… ConexÃ£o SSH estabelecida com sucesso!"
            echo "ðŸ“ Preparando diretÃ³rio de deploy..."
            # Expandir ~ para o caminho completo
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
            if [[ "$DEPLOY_PATH" == ~* ]]; then
              DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
            fi
            echo "Caminho: $DEPLOY_PATH"
            # Criar diretÃ³rio se nÃ£o existir
            mkdir -p "$DEPLOY_PATH"
            # Garantir permissÃµes corretas
            chmod 755 "$DEPLOY_PATH"
            echo "âœ… DiretÃ³rio preparado: $DEPLOY_PATH"
            pwd
            whoami

      - name: Deploy to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "."
          target: ${{ secrets.VPS_DEPLOY_PATH }}
          strip_components: 0
          overwrite: true

      - name: Execute deployment commands on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # Cria o diretÃ³rio se nÃ£o existir
            mkdir -p ${{ secrets.VPS_DEPLOY_PATH }}
            cd ${{ secrets.VPS_DEPLOY_PATH }}
            
            # Remove arquivos que nÃ£o devem estar no deploy
            rm -rf node_modules .git .github .env *.log .DS_Store prisma/database.db prisma/database.db-journal .vscode .idea 2>/dev/null || true
            
            # Verifica se Node.js estÃ¡ instalado
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js nÃ£o estÃ¡ instalado. Por favor, instale Node.js 18+ na VPS."
              exit 1
            fi
            
            # Verifica se MySQL estÃ¡ instalado (aviso apenas, nÃ£o bloqueia)
            if ! command -v mysql &> /dev/null; then
              echo "âš ï¸ MySQL nÃ£o encontrado. Certifique-se de que o MySQL estÃ¡ instalado e rodando."
              echo "Para instalar: sudo apt install mysql-server -y"
            else
              # Verifica se MySQL estÃ¡ rodando
              if ! systemctl is-active --quiet mysql 2>/dev/null && ! systemctl is-active --quiet mysqld 2>/dev/null; then
                echo "âš ï¸ MySQL nÃ£o estÃ¡ rodando. Inicie com: sudo systemctl start mysql"
              fi
            fi
            
            # Verifica se o arquivo .env existe (obrigatÃ³rio)
            if [ ! -f .env ]; then
              echo "âš ï¸ Arquivo .env nÃ£o encontrado!"
              echo "Por favor, crie o arquivo .env com as configuraÃ§Ãµes necessÃ¡rias antes do deploy."
              exit 1
            fi
            
            # Carrega variÃ¡veis de ambiente
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
            fi
            
            echo "ðŸ“¦ Instalando dependÃªncias..."
            # Usa npm install na primeira vez, npm ci depois
            if [ ! -d node_modules ]; then
              npm install
            else
              npm ci --production=false
            fi
            
            echo "ðŸ”§ Gerando Prisma Client..."
            npm run prisma:generate
            
            echo "ðŸ—„ï¸ Executando migraÃ§Ãµes do banco de dados..."
            npm run prisma:migrate deploy
            
            echo "ðŸŽ¨ Compilando CSS..."
            npx tailwindcss -i ./src/public/css/input.css -o ./src/public/css/output.css --minify
            
            echo "ðŸ”„ Reiniciando aplicaÃ§Ã£o..."
            # OpÃ§Ã£o 1: PM2 (recomendado)
            if command -v pm2 &> /dev/null; then
              if pm2 list | grep -q "app-offline"; then
                pm2 restart app-offline
                echo "âœ… AplicaÃ§Ã£o reiniciada com PM2"
              else
                pm2 start server.js --name app-offline
                pm2 save
                echo "âœ… AplicaÃ§Ã£o iniciada com PM2"
              fi
            # OpÃ§Ã£o 2: systemd
            elif systemctl is-active --quiet app-offline.service 2>/dev/null; then
              sudo systemctl restart app-offline
              echo "âœ… AplicaÃ§Ã£o reiniciada com systemd"
            # OpÃ§Ã£o 3: Iniciar diretamente (fallback)
            else
              echo "âš ï¸ PM2 ou systemd nÃ£o encontrado. Iniciando aplicaÃ§Ã£o diretamente..."
              pkill -f "node server.js" 2>/dev/null || true
              nohup node server.js > app.log 2>&1 &
              echo "âœ… AplicaÃ§Ã£o iniciada diretamente (verifique app.log para logs)"
            fi
            
            echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"

